<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Force Graph</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .node {
            fill: #ddd;
            stroke: #fff;
            stroke-width: 1.5px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <h1 class="text-center my-3">Force Graph</h1>
                <div class="form-group">
                    <label for="input">Input</label>
                    <textarea class="form-control" id="input" rows="10"></textarea>
                </div>
                <button class="btn btn-primary btn-block" onclick="drawGraph()">Draw Graph</button>
                <div id="graph" class="my-3" style="width: 500px; height: 500px;"></div>
            </div>
        </div>
    </div>
    <script>
        let drawGraph = () => {
            const input = JSON.parse(document.getElementById('input').value);

            // Set the dimensions of the SVG
            const width = 500;
            const height = 500;

            // Create the SVG element
            const svg = d3.create('svg')
                .attr('width', width)
                .attr('height', height);

            const colorScale = d3.scaleLinear()
                .domain([0, 0.1])
                .range(['#d7f2fd','#11aacc']);
            const sizeScale = d3.scaleLinear()
                .domain([0, 10000])
                .range([5, 20]);
            const opacityScale = d3.scaleLinear()
                .domain([0, 1])
                .range([0.3, 1]);
            // const strengthScale = d3.scaleLinear()
            //     .domain([0, 1])
            //     .range([0.1, 1]);
            const strengthScale = d3.scalePow()
                .exponent(2)
                .domain([0, 1])
                .range([0.1, 1]);
            const distanceScale = d3.scaleLinear()
                .domain([0, 1])
                .range([0, 500]);


            let trustToPercent = (number) => {
                Math.round(a * 10 ** 3)
            }

            


            // Create the simulation
            const simulation = d3.forceSimulation(input.nodes)
                .force('charge', d3.forceManyBody().strength(-200))
                .force('link', d3.forceLink(input.links).distance(250))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('link', d3.forceLink().id(d => d.id).strength(d => strengthScale(d.trust)).distance(d =>
                    distanceScale(d.trust)))
                // .force('charge', d3.forceManyBody().strength(-200))
                // .force('center', d3.forceCenter(width / 2, height / 2))
                .force('x', d3.forceX())
                .force('y', d3.forceY())
                .on('tick', ticked);

            // Add the links to the SVG
            const link = svg.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(input.links)
                .join('line')
                .attr('class', 'link');

            // Add the nodes to the SVG
            const node = svg.append('g')
                .attr('class', 'nodes')
                .selectAll('circle')
                .data(input.nodes)
                .join('circle')
                .attr('class', 'node')
                .attr('r', d => (d.trustMetrics.overallTrust * 25))
                .call(drag(simulation));

            // Add labels to the nodes
            const label = svg.append('g')
                .attr('class', 'labels')
                .selectAll('text')
                .data(input.nodes)
                .join('text')
                .text(d => (d.name + '\n group:' + (d.group)))
                .attr('dx', 15)
                .attr('dy', 4);

            // Update the positions of the elements on each tick of the simulation
            function ticked() {
                applyTrustMetrics(input.nodes, input.links);
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            }

            // Add drag behavior to the nodes
            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }

                function dragged(event) {
                    // console.log(event);
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }

                return d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended);
            }

            function applyTrustMetrics(nodes, links) {

                // Select the nodes and links in the force graph
                const node = d3.selectAll('.node');
                const link = d3.selectAll('.link');

                // Set the colors, sizes, opacities, strengths, and distances based on the trust metrics
                node.style('fill', d => colorScale(d.trustMetrics.overallTrust))
                    .attr('r', d => sizeScale(d.trustMetrics.overallTrust));
                link.style('stroke', d => colorScale(d.trust))
                    .style('opacity', d => opacityScale(d.trust));
                simulation.force('link').strength(d => strengthScale(d.trust)).distance(d => distanceScale(d
                    .trust));
            }


            // Select the div element to render the force graph
            const graphDiv = d3.select('#graph');

            // Append the SVG element to the div element
            graphDiv.node().appendChild(svg.node());

        }
    </script>
</body>

</html>